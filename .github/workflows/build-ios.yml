# File: .github/workflows/haxe-ipa.yml
name: Build-iOS-Unsigned-IPA

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-13          # Xcode 15.4 image
    steps:

    ############################################################
    # 1 ▸ Check out your repo
    ############################################################
    - uses: actions/checkout@v4

    ############################################################
    # 2 ▸ PATCH bad make path (unchanged)
    ############################################################
    - name: Fix “Build Haxe” make-path
      shell: bash
      run: |
        PBX="export/ios/MonsterMind.xcodeproj/project.pbxproj"
        sed -Ei.bak \
          -e 's|/Applications/Xcode[^"]*/usr/bin/make|/usr/bin/make|g' \
          -e 's|\$\([Dd][Ee][Vv][Ee][Ll][Oo][Pp][Ee][Rr]_[Dd][Ii][Rr]\)/usr/bin/make|/usr/bin/make|g' \
          "$PBX"

    ############################################################
    # 3 ▸ BUILD the .app  ➜  also echo the dSYM path
    ############################################################
    - name: Compile (unsigned)
      id: buildapp
      shell: bash
      run: |
        cd export/ios
        xcodebuild \
          -project   MonsterMind.xcodeproj \
          -scheme    MonsterMind \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          -derivedDataPath build \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGNING_REQUIRED=NO \
          clean build

        APP_PATH=$(find build -name '*.app'  -type d | head -n 1)
        DSYM_PATH=$(find build -name '*.dSYM' -type d | head -n 1)

        echo "app=$APP_PATH"  >> "$GITHUB_OUTPUT"
        echo "dsym=$DSYM_PATH" >> "$GITHUB_OUTPUT"

    ############################################################
    # 4 ▸ PACKAGE the .app into an unsigned IPA  (unchanged)
    ############################################################
    - name: Create unsigned IPA
      shell: bash
      working-directory: export/ios
      run: |
        mkdir -p Payload
        cp -R "${{ steps.buildapp.outputs.app }}" Payload/
        /usr/bin/zip -qry MonsterMind-unsigned.ipa Payload

    ############################################################
    # 5 ▸ ZIP the matching dSYM  (NEW)
    ############################################################
    - name: Zip dSYM
      shell: bash
      run: |
        zip -qry MonsterMind.dSYM.zip "${{ steps.buildapp.outputs.dsym }}"

    ############################################################
    # 6 ▸ UPLOAD both IPA and dSYM  (updated)
    ############################################################
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: MonsterMind-build
        path: |
          export/ios/MonsterMind-unsigned.ipa
          MonsterMind.dSYM.zip
        retention-days: 7
