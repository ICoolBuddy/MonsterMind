name: Build-iOS-Unsigned-IPA

on:
  workflow_dispatch          # add "push:" if you want auto-builds

jobs:
  build:
    runs-on: macos-13        # Xcode 15.4 image
    steps:
    - uses: actions/checkout@v4

    # 1️⃣  Rewrite the absolute make-path inside the .pbxproj
    - name: Point “Build Haxe” build tool to /usr/bin/make
      shell: bash
      run: |
        cd export/ios
        # Replace any “…Developer/usr/bin/make” with /usr/bin/make
        sed -Ei.bak 's|/Applications/Xcode[^"]*/usr/bin/make|/usr/bin/make|g' \
          MonsterMind.xcodeproj/project.pbxproj
        # show what we changed (one line) for the log
        grep -n '"Build Haxe"' -A4 -B2 MonsterMind.xcodeproj/project.pbxproj | head -n 12

    # 2️⃣  Build with signing disabled
    - name: Build .app (codesign disabled)
      id: buildapp
      shell: bash
      run: |
        cd export/ios
        xcodebuild \
          -project   MonsterMind.xcodeproj \
          -scheme    MonsterMind \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          -derivedDataPath build \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGN_ENTITLEMENTS="" \
          clean build
        APP_PATH=$(find build -name '*.app' -type d | head -n 1)
        echo "app=$APP_PATH" >> "$GITHUB_OUTPUT"

    # 3️⃣  Package the unsigned .ipa
    - name: Package unsigned .ipa
      shell: bash
      working-directory: export/ios
      run: |
        mkdir -p Payload
        cp -R "${{ steps.buildapp.outputs.app }}" Payload/
        /usr/bin/zip -qry MonsterMind-unsigned.ipa Payload

    # 4️⃣  Upload the artifact
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: MonsterMind-unsigned
        path: export/ios/MonsterMind-unsigned.ipa
        retention-days: 7
